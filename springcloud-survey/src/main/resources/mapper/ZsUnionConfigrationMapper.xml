<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.camel.survey.mapper.ZsUnionConfigrationMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.camel.survey.model.ZsUnionConfigration">
        <id column="id" property="id"/>
        <result column="options" property="options"/>
        <result column="config" property="config"/>
        <result column="survey_id" property="surveyId"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, options, config, survey_id
    </sql>

    <select id="list" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"></include>
        from
        zs_union_configration
        <where>
            1=1
            <if test="surveyId != null">
                and survey_id = #{surveyId}
            </if>
        </where>
    </select>

    <select id="selectValidAnserCountByMultipleOption" resultType="integer">
        SELECT
        COUNT(1)
        FROM
        (
        SELECT
        creator,
        sum(
        CASE
        WHEN option_id IN
        <foreach collection="options" item="item" index="index" open="(" close=")" separator=",">
            #{item}
        </foreach>
        THEN
        1
        ELSE
        0
        END
        ) AS count
        FROM
        zs_answer_item
        WHERE
        survey_id = #{surveyId}
        AND `status` = 1
        AND valid = 1
        GROUP BY
        answer_id
        ) result
        WHERE
        result.count >= 2
    </select>
</mapper>
