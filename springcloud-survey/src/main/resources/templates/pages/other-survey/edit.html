<div id="subContainer" class="wrapper wrapper-content">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="signupForm">
                <div class="form-group">
                    <label class="col-sm-3 control-label">问卷名称：</label>
                    <div class="col-sm-8">
                        <input id="name" name="name" class="form-control" type="text" v-model="otherSurvey.name">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">问卷类型：</label>
                    <div class="col-sm-8">
                        <select name="type" aria-required="true"
                                aria-invalid="true" class="form-control m-b"
                                v-model="otherSurvey.type">
                            <option value="0">中移项目</option>
                            <option value="1">民调项目</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">问卷地点：</label>
                    <div class="col-sm-8">
                        <input id="place" name="place" class="form-control" type="text" v-model="otherSurvey.place">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">问卷时间：</label>
                    <div class="col-sm-8">
                        <div class="input-group input-medium date-picker input-daterange" data-date-format="yyyy-mm-dd">
                            <input id="starttime" name="starttime" class=" datepicker" autocomplete="off" ref="inputstart" placeholder="请选择开始时间"  style="font-size: 13px;" type="text" v-model="start">
                            <span class="input-group-addon">—————</span>
                            <input id="endtime" name="endtime" class="datepicker" autocomplete="off" ref="inputend" placeholder="请选择结束时间"  style="font-size: 13px;" type="text" v-model="end">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-8 col-sm-offset-3">
                        <h5 style="color:red" v-if="timeregular == 1">请按照00:00的方式输入时间，且结束时间大于开始时间</h5>
                        <button type="button" class="btn btn-secondary" v-on:click="cancel()">取消</button>
                        <button type="button" class="btn btn-primary" v-on:click="save()">保存</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="/survey/js/validateIsMain.js"></script>
<script>
    new Vue({
        el: '#subContainer',
        data: {
            applicationContextRootPath: '/survey/',
            otherSurvey: {
                name: '',
                type:null,
                place:'',
                ptime:'',
            },
            start:"",
            end:"",
            timeregular: 0,
        },
        created: function () {
            this.loadEntity();
        },
        methods: {
            loadEntity() {
                var that = this;
                AJAX.GET('zsOtherSurvey/' + sessionStorage.getItem('editParams'), {}, function (resp) {
                    that.otherSurvey = {
                        id: resp.data.id,
                        name: resp.data.name,
                        type: resp.data.type ? resp.data.type.value : null,
                        place: resp.data.place,
                        ptime: resp.data.ptime,
                    };
                    that.start=that.otherSurvey.ptime.substring(0,5);
                    that.end=that.otherSurvey.ptime.substring(6,11);
                })
            },
            cancel: function () {
                this.backToMain();
            },
            save: function () {
                console.log($("#signupForm").valid());
                if (!$("#signupForm").valid()) {
                    return false;
                }
                var that = this;
                var time = /^\d{2}:\d{2}$/;
                that.timeregular = 0;
                let start=this.$refs.inputstart.value;
                let end=this.$refs.inputend.value;
                if(!time.test(start)&&!time.test(end)){
                    that.timeregular = 1;
                    return false;
                }
                var hours = parseInt(end.substring(0,3))-parseInt(start.substring(0,3));
                var minutes = parseInt(end.substring(4))-parseInt(start.substring(4));
                if(hours<0){
                    that.timeregular = 1;
                    return false;
                }else if (hours == 0){
                    if(minutes<1){
                        that.timeregular = 1;
                        return false;
                    }
                }
                that.otherSurvey.ptime = start + "-" + end;
                AJAX.PUT('zsOtherSurvey', JSON.stringify(this.otherSurvey), function (resp) {
                    if(resp) {
                        toastr.success(resp.msg);
                        that.backToMain();
                    }
                });
            },
            backToMain: function () {
                $.pjax({
                    url: mvm.applicationContextRootPath + 'pages/other-survey/index.html',
                    container: '.page-container'
                });
            }
        }
    });


    $().ready(function () {
        var icon = "<i class='fa fa-times-circle'></i> ";
        $("#signupForm").validate({
            rules: {
                name: "required",
                place: "required",
                starttime: "required",
                endtime: "required",
            },
            messages: {
                name: icon + "请输入问卷名称",
                place: icon + "请输入地址",
                starttime: icon + "请选择开始时间",
                endtime: icon + "请选择结束时间",
            }
        });


        $('#data_1 .input-group.date').datepicker({
            todayBtn: "linked",
            keyboardNavigation: false,
            forceParse: false,
            calendarWeeks: true,
            autoclose: true
        });
        $("#endtime").hunterTimePicker();
        //时间选择
        $("#starttime").hunterTimePicker();
        // propose username by combining first- and lastname
        $("#username").focus(function () {
            var firstname = $("#firstname").val();
            var lastname = $("#lastname").val();
            if (firstname && lastname && !this.value) {
                this.value = firstname + "." + lastname;
            }
        });
    });
</script>