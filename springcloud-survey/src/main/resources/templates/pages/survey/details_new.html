<style>
    .droppable-active {
        background-color: #ffe !important;
    }

    .tools a {
        cursor: pointer;
        font-size: 80%;
    }

    .form-body .col-md-6,
    .form-body .col-md-12 {
        min-height: 400px;
    }

    .draggable {
        cursor: move;
    }

    .sortable > div:hover {
        border: 1px darkgray dotted;
    }

    .option:hover {
        border: 1px darkgray dotted;
    }

    .cursor-pointer {
        cursor: pointer;
    }
</style>

<div id="subContainer" class="wrapper wrapper-content">
    <div class="row">
        <div class="col-sm-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>元素</h5>
                </div>
                <div class="ibox-content">
                    <div class="alert alert-info">
                        拖拽左侧的体型到右侧区域，即可生成快速模板
                    </div>
                    <form role="form" class="form-horizontal m-t">
                        <div class="form-group draggable alert alert-success" draggable="true"
                             @dragstart="dragstart($event, {type: 1})" @dragend="dragend($event)">
                            <label class="col-sm-12">单选题：</label>
                        </div>
                        <div class="form-group draggable alert alert-info" draggable="true"
                             @dragstart="dragstart($event, {type: 2})" @dragend="dragend($event)">
                            <label class="col-sm-12">多选题：</label>
                        </div>
                        <div class="form-group draggable alert alert-warning" draggable="true"
                             @dragstart="dragstart($event, {type: 3})" @dragend="dragend($event)">
                            <label class="col-sm-12">问答题：</label>
                        </div>
                    </form>
                    <div class="clearfix"></div>
                </div>
            </div>
        </div>
        <div class="col-sm-8">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>拖拽左侧表单元素到此区域</h5>
                </div>
                <div class="ibox-content">
                    <div class="row form-body form-horizontal m-t">
                        <div class="col-md-12 droppable sortable" @drop="drop" @dragover.prevent id="form-body">
                            <div class="form-group" v-for="(question, index) in questions">
                                <div class="row no-margins" style="background-color: bisque; cursor: pointer;"
                                     v-on:click="questionNameClickHandler(question)">
                                    <label class="col-sm-1 control-label">{{index + 1}}.</label>
                                    <div class="col-sm-11 form-control-static">
                                        <p class="label">{{question.name}} {{question.orderNum}}</p>

                                        <span style="float: right;">
														<span class="label label-success"
                                                              v-on:click="up($event, question)">
															<p class="fa fa-arrow-up"></p>
														</span>
														<span class="label label-primary"
                                                              v-on:click="down($event, question)">
															<p class="fa fa-arrow-down"></p>
														</span>
													</span>
                                    </div>
                                </div>
                                <div class="row no-margins option" style="cursor: pointer; background-color: gainsboro;"
                                     v-for="zsoption in zsoptions"
                                     v-on:click="optionNameClickHandler( $event, zsoption)"
                                     v-if="zsoption.questionOrderNum == question.orderNum">
                                    <label class="col-sm-1 control-label" style="padding-right: 0;">
                                        <option value="" class="length">{{zsoption.orderNum}}.</option>
                                    </label>
                                    <div class="col-sm-11" v-if="question.type === 1">
                                        <div class="radio">
                                            <label><input type="radio" :value="zsoption.name">{{zsoption.name}}</label>
                                            <span style="float: right;">
															<span class="label label-success"
                                                                  v-on:click="upOption($event, zsoption)">
																<p class="fa fa-arrow-up"></p>
															</span>
															<span class="label label-primary"
                                                                  v-on:click="downOption($event, zsoption)">
																<p class="fa fa-arrow-down"></p>
															</span>
														</span>
                                        </div>
                                    </div>
                                    <div class="col-sm-11" v-if="question.type === 2">
                                        <div class="radio">
                                            <label><input type="checkbox"
                                                          :value="zsoption.name">{{zsoption.name}}</label>
                                            <span style="float: right;">
															<span class="label label-success"
                                                                  v-on:click="upOption($event, zsoption)">
																<p class="fa fa-arrow-up"></p>
															</span>
															<span class="label label-primary"
                                                                  v-on:click="downOption($event, zsoption)">
																<p class="fa fa-arrow-down"></p>
															</span>
														</span>
                                        </div>
                                    </div>

                                    <div class="col-sm-11" v-if="question.type === 3">
                                        <div class="radio">
                                            <label>{{zsoption.name}}</label>
                                            <span style="float: right;">
															<span class="label label-success"
                                                                  v-on:click="upOption($event, zsoption)">
																<p class="fa fa-arrow-up"></p>
															</span>
															<span class="label label-primary"
                                                                  v-on:click="downOption($event, zsoption)">
																<p class="fa fa-arrow-down"></p>
															</span>
														</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row no-margins" style="background-color: bisque;">
                                    <label class="col-sm-2 control-label" style="padding-right: 0;">
													<span v-on:click="addNewOption(question)" class="cursor-pointer">
														<span class="fa fa-plus-circle" style="font-size: 20px;"></span>
														新增选项
													</span>
                                    </label>
                                    <div class="col-sm-10" v-if="question.type === 1">

                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="text-center">
                            <button class="btn btn-success" v-on:click="save()">保存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="qustionModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"
                            v-on:click="hideModal('questionMadal')">&times;
                    </button>
                    <h2 translate>题目属性</h2>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">题目标题</label>
                            <div class="col-sm-9">
                                <input class="form-control" text="text" name="name" v-model="selectedQuestion.name"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">题目类型</label>
                            <div class="col-sm-9">
                                <select class="form-control m-b" disabled text="text" name="type"
                                        v-model="selectedQuestion.type">
                                    <option value="1">单选题</option>
                                    <option value="2">多选题</option>
                                    <option value="3">问答题</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">最多选择</label>
                            <div class="col-sm-9">
                                <input class="form-control" type="number" name="maxSelect"
                                       v-model="selectedQuestion.maxSelect" placeholder="最多选择数量，默认为1"/>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">最少选择</label>
                            <div class="col-sm-9">
                                <input class="form-control" type="number" name="minSelect"
                                       v-model="selectedQuestion.minSelect" placeholder="最少选择数量，默认为1"/>
                            </div>
                        </div>
                        <div class="form-group text-center">
                            <span class="btn btn-danger" v-on:click="deleteQuestion(selectedQuestion)">删除问题</span>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="optionModal" ng-controller="KisBpmChoseAssignmentCtrl">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"
                            v-on:click="hideModal('optionModal')"><p class="fa fa-check"></p></button>
                    <h2 translate>选项属性</h2>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">选项文本</label>
                            <div class="col-sm-9">
                                <input class="form-control" type="text" name="name" v-model="selectedOption.name"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">选项配额</label>
                            <div class="col-sm-9">
                                <input class="form-control" type="number" name="configration"
                                       v-model="selectedOption.configration" placeholder="本数据量收集顶额，默认不限制"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">选择跳转</label>
                            <div class="col-sm-9">
                                <input class="form-control" type="number" name="target" v-model="selectedOption.target"
                                       placeholder="跳转至自定义题号，默认为当前题号+1"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">计入配额</label>
                            <div class="col-sm-9">
                                <select class="form-control m-b" text="text" name="ignoreNum"
                                        v-model="selectedOption.ignoreNum" placeholder="是否计入配额">
                                    <option value="true">计入配额</option>
                                    <option value="false">不计入配额</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">是否备注</label>
                            <div class="col-sm-9">
                                <select class="form-control m-b" text="text" name="hasRemark"
                                        v-model="selectedOption.hasRemark" placeholder="是否需要备注">
                                    <option v-for="val in [true, false]" :value="val">{{ val ? '需要' : '不需要' }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" v-if="selectedOption.hasRemark">
                            <label class="col-sm-3 control-label">备注提示</label>
                            <div class="col-sm-9">
                                <input class="form-control" type="text" name="remark" v-model="selectedOption.remark"
                                       placeholder="备注的提示信息"/>
                            </div>
                        </div>

                        <div class="form-group text-center">
                            <span class="btn btn-danger" v-on:click="deleteOption(selectedOption)">删除选项</span>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="/survey/js/plugins/beautifyhtml/beautifyhtml.js"></script>
<script src="/survey/js/validateIsMain.js"></script>
<script>
    new Vue({
        el: '#subContainer',
        data: {
            questions: [],
            zsoptions: [],
            surveyId: sessionStorage.getItem('editParams'),
            selectedQuestion: {},
            selectedOption: {},
            selectedIndex: 0
        },
        created: function () {
            this.loadSurvey();
            this.loadQuestions();
        },
        mounted() {
        },
        methods: {
            loadQuestions() {
                let that = this;
                AJAX.GET('zsSurvey/questionAndOptions/' + sessionStorage.getItem('editParams'), {}, function (resp) {
                    for (let i = 0; i < resp.data.length; i++) {
                        let item = resp.data[i];
                        let tmpQ = {
                            id: item.id,
                            orderNum: item.orderNum,
                            name: item.name,
                            type: item.type,
                            surveyId: item.surveyId,
                            maxSelect: item.maxSelect,
                            minSelect: item.minSelect
                        };
                        for (let j = 0; j < item.options.length; j++) {
                            let o = item.options[j];
                            let opt = {
                                orderNum: o.orderNum,
                                name: o.name,
                                target: o.target,
                                hasRemark: o.hasRemark,
                                ignoreNum: o.ignoreNum,
                                configration: o.configration, // 选项配额
                                questionOrderNum: item.orderNum
                            };
                            that.zsoptions.push(opt);
                        }

                        that.questions.push(tmpQ);
                    }
                })
            },
            loadSurvey() {
                var that = this;
                AJAX.GET('zsSurvey/' + sessionStorage.getItem('editParams'), {}, function (resp) {
                    that.survey = {
                        id: resp.data.id,
                        name: resp.data.name,
                        currentNum: resp.data.currentNum,
                        collectNum: resp.data.collectNum,
                        projectId: resp.data.projectId,
                        collectType: resp.data.collectType,
                        ignoreNum: resp.data.ignoreNum
                    };
                })
            },
            save() {
                let that = this;
                let params = {};
                params.zsQuestions = this.questions;
                params.zsOptions = this.zsoptions;
                params.surveyId = this.surveyId;
                AJAX.POST_JSON('zsQuestion', params, function (resp) {
                    toastr.success(resp.msg);
                    sessionStorage.setItem('editParams', that.survey.projectId);
                    toPage('pages/project/details.html');
                });
            },
            upOption(e, option) {
                e.stopPropagation();
                if (option.orderNum === 1) {
                    toastr.error("已经是第一个元素了");
                }
                let options = this.getOptionsByQuestion(option.questionOrderNum);
                let preOption = this.getOptionByOrderNum(option.orderNum - 1, options);
                let currentIndex = this.zsoptions.indexOf(option);
                preOption.orderNum = option.orderNum;
                option.orderNum = option.orderNum - 1;
                this.$set(this.zsoptions, currentIndex, preOption);
                this.$set(this.zsoptions, currentIndex - 1, option);

            },
            downOption(e, option) {
                e.stopPropagation();
                let options = this.getOptionsByQuestion(option.questionOrderNum);
                if (option.orderNum === options.length) {
                    toastr.error("已经是最后一个元素了");
                }
                let nextOption = this.getOptionByOrderNum(option.orderNum + 1, options);
                let currentIndex = this.zsoptions.indexOf(option);
                nextOption.orderNum = option.orderNum;
                option.orderNum = option.orderNum + 1;
                this.$set(this.zsoptions, currentIndex, nextOption);
                this.$set(this.zsoptions, currentIndex + 1, option);
            },
            getOptionsByQuestion(questionOrderNum) {
                let options = [];
                $.each(this.zsoptions, function (index, item) {
                    console.log(item);
                    if (item.questionOrderNum === questionOrderNum) {
                        options.push(item);
                    }
                });
                return options;
            },
            getOptionByOrderNum(orderNum, options) {
                let option;
                $.each(options, function (index, item) {
                    if (item.orderNum === orderNum) {
                        option = item;
                        return item;
                    }
                });
                return option;
            },
            addNewOption(question) {
                let c = 0;
                for (let i = 0; i < this.zsoptions.length; i++) {
                    if (this.zsoptions[i].questionOrderNum === question.orderNum) {
                        c++;
                    }
                }
                let tmp = {
                    name: '新选项',
                    type: question.type,
                    orderNum: c + 1,
                    hasRemark: false,
                    ignoreNum: false,
                    questionOrderNum: question.orderNum
                }
                this.zsoptions.push(tmp)
            },
            deleteOption(option) {
                this.zsoptions.splice(this.zsoptions.indexOf(option), 1);
                this.hideModal('optionModal');
            },
            deleteQuestion(question) {
                let tmp = [];
                for (let i = 0; i < this.zsoptions.length; i++) {
                    if (this.zsoptions[i].questionOrderNum === question.orderNum) {
                        tmp.push(this.zsoptions[i]);
                    }
                }
                for (let i = 0; i < tmp.length; i++) {
                    this.zsoptions.splice(this.zsoptions.indexOf(tmp[i]), 1);
                }
                this.questions.splice(this.questions.indexOf(question), 1);
                this.hideModal('qustionModal');
            },
            optionNameClickHandler(e, option) {
                this.selectedIndex = this.zsoptions.indexOf(option);
                e.stopPropagation;
                this.selectedOption = option;
                this.showModal('optionModal');
            },
            up(e, question) {
                console.log(question);
                let currentIndex = this.questions.indexOf(question);
                e.stopPropagation();
                if (currentIndex == 0) {
                    toastr.error("已经是第一个元素了");
                    return false;
                }
                let preQuestion = this.questions[currentIndex - 1]
                preQuestion.orderNum = currentIndex + 1;
                question.orderNum = currentIndex;
                this.$set(this.questions, currentIndex - 1, question);
                this.$set(this.questions, currentIndex, preQuestion);
                this.updateOption(question, true);
            },
            down(e, question) {
                console.log(question);
                let currentIndex = this.questions.indexOf(question);
                e.stopPropagation();
                if (currentIndex == this.questions.length - 1) {
                    toastr.error("已经是最后一个元素了");
                    return false;
                }
                let nextQuestion = this.questions[currentIndex + 1]
                nextQuestion.orderNum = currentIndex + 1;
                question.orderNum = currentIndex + 2;
                this.$set(this.questions, currentIndex + 1, question);
                this.$set(this.questions, currentIndex, nextQuestion);
                this.updateOption(question, false);
            },
            updateOption(question, isUp) {
                if (isUp) {
                    for (let i = 0; i < this.zsoptions.length; i++) {
                        if (this.zsoptions[i].questionOrderNum == question.orderNum) {
                            this.zsoptions[i].questionOrderNum += 1;
                        } else if (this.zsoptions[i].questionOrderNum == (question.orderNum + 1)) {
                            this.zsoptions[i].questionOrderNum -= 1;
                        }
                        this.$set(this.zsoptions, i, this.zsoptions[i]);
                    }
                } else {
                    for (let i = 0; i < this.zsoptions.length; i++) {
                        if (this.zsoptions[i].questionOrderNum == question.orderNum) {
                            this.zsoptions[i].questionOrderNum -= 1;
                        } else if (this.zsoptions[i].questionOrderNum == question.orderNum - 1) {
                            this.zsoptions[i].questionOrderNum += 1;
                        }
                        this.$set(this.zsoptions, i, this.zsoptions[i]);
                    }
                }

            },
            questionNameClickHandler(question) {
                this.selectedQuestion = question;
                this.showModal('qustionModal');
            },
            showModal(id) {
                $("#" + id).modal('show');
            },
            dragstart(e, data) {
                console.log(e, data);
                e.dataTransfer.setData('item', data.type)
            },
            dragend(e) {
                e.dataTransfer.clearData()
            },
            drop(event) {
                this.renderElement(event.dataTransfer.getData('item'));
            },
            renderElement(type) {
                if (parseInt(type) === 1) {
                    this.renderSingleSelect()
                }
                if (parseInt(type) === 2) {
                    this.renderMuiltySelect()
                }
                if (parseInt(type) === 3) {
                    this.renderDetailQuestion()
                }
            },
            renderSingleSelect() {
                let question = {
                    name: "单选题",
                    type: 1,
                    orderNum: this.questions.length + 1,
                    minSelect: 1,
                    surveyId: this.surveyId,
                    maxSelect: 1
                };
                let tmpOptions = [
                    {
                        name: '选项一',
                        type: '1',
                        orderNum: 1,
                        hasRemark: false,
                        ignoreNum: false,
                        questionOrderNum: question.orderNum

                    }, {
                        name: '选项二',
                        type: '1',
                        orderNum: 2,
                        hasRemark: false,
                        ignoreNum: false,
                        questionOrderNum: question.orderNum
                    },
                ];
                this.questions.push(question);
                this.zsoptions = this.zsoptions.concat(tmpOptions);
            },
            renderMuiltySelect() {
                let question = {
                    name: "多选题",
                    type: 2,
                    orderNum: this.questions.length + 1,
                    surveyId: this.surveyId,
                    minSelect: 1,
                    maxSelect: 2
                };
                let tmpOptions = [
                    {
                        name: '选项一',
                        type: '2',
                        orderNum: 1,
                        hasRemark: false,
                        ignoreNum: false,
                        questionOrderNum: question.orderNum

                    }, {
                        name: '选项二',
                        type: '2',
                        orderNum: 2,
                        hasRemark: false,
                        ignoreNum: false,
                        questionOrderNum: question.orderNum
                    },
                ];
                this.questions.push(question);
                this.zsoptions = this.zsoptions.concat(tmpOptions);
            },
            renderDetailQuestion() {
                let question = {
                    name: "问答题",
                    type: 2,
                    orderNum: this.questions.length + 1,
                    minSelect: 1,
                    maxSelect: 2
                };
                let tmpOptions = [
                    {
                        name: '选项',
                        type: '3',
                        orderNum: 1,
                        hasRemark: false,
                        ignoreNum: false,
                        questionOrderNum: question.orderNum

                    }
                ];
                this.questions.push(question);
                this.zsoptions = this.zsoptions.concat(tmpOptions);
            },
            hideModal(id) {
                $('#' + id).modal('hide');
                // if(id == 'optionModal') {
                // 	console.log(this.selectedIndex);
                // 	console.log(this.zsoptions[this.selectedIndex])
                // 	this.zsoptions[this.selectedIndex] = this.selectedOption;
                // }
            }
        },

    });
</script>
