<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>我要推荐</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <link rel="stylesheet" href="/viewer/wx/css/weui.min.css">
    <link rel="stylesheet" href="/viewer/wx/css/weui.css">
    <link rel="stylesheet" href="/viewer/wx/css/jquery-weui.css">
    <link rel="stylesheet" href="/viewer/wx/css/demos.css">
    <script src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <script src="/viewer/wx/js/vue.js"></script>

    <script src="/viewer/wx/js/jquery-2.1.4.js"></script>
    <script src="/viewer/wx/js/jweixin-1.6.0.js"></script>

</head>
<body ontouchstart>
<div class="container" id="container">
    <div v-if="!viewModel">
        <div class="weui_msg" v-if="!ticket">
            <div class="weui_icon_area">
                <i class="weui_icon_cancel weui_icon_msg"></i></div>
            <div class="weui_text_area">
                <h2 class="weui_msg_title">无权限操作</h2>
                <p class="weui_msg_desc">请您完善个人信息后再次尝试</p>
            </div>
            <div class="weui_extra_area">
            </div>
        </div>
        <div class="weui-panel" style="padding-top: 10%;" v-if="ticket">
            <img v-bind:src="qrCodeSrc()" style="width: 50%;">
            <p>我的推荐二维码，长按保存发给朋友，或者直接转发给朋友或朋友圈</p>
        </div>
    </div>
    <div v-if="viewModel">
        <div class="weui-panel" style="padding-top: 10%;" v-if="ticket">
            <img v-bind:src="qrCodeSrc()" style="width: 50%;">
            <p>这是我的推荐，长按识别二维码，关智慧调查，和我一起。。。</p>
        </div>
    </div>
</div>
<script src="/viewer/wx/js/fastclick.js"></script>
<script>
    $(function () {
        FastClick.attach(document.body);
    });
</script>
<script src="/viewer/wx/js/jquery-weui.js"></script>
<script src="/viewer/wx/js/ajax-util.js"></script>
</body>

<script type="application/javascript">
    new Vue({
        el: '#container',
        data: {
            ticket: null,
            qrCode: "https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=",
            signature: null,
            viewModel: false
        },
        created: function () {
            this.initQRCode();
        },
        methods: {
            qrCodeSrc() {
                return this.qrCode + this.ticket;
            },
            initWxConfig(params) {
                let that = this;
                wx.config({
                    debug: true,
                    appId: params.appId,
                    timestamp: params.timestamp,
                    nonceStr: params.nonceStr,
                    signature: params.signature,
                    jsApiList: ['updateAppMessageShareData', 'updateTimelineShareData']
                });
                wx.ready(function () {
                    // let baseUrl = "http://diaocha.natapp1.cc/";
                    let baseUrl = "https://diaocha.svdata.cn/";
                    // 自定义“分享给朋友”及“分享到QQ”按钮的分享内容（1.4.0）
                    wx.updateAppMessageShareData({
                        title: '我咋地咋地了', // 分享标题
                        desc: '你也来咋地', // 分享描述
                        link: baseUrl + 'viewer/view/share?ticket=' + that.ticket, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                        imgUrl: baseUrl + 'survey/img/avatar/29.png', // 分享图标
                        success: function () {
                        }
                    });
                    // 自定义“分享到朋友圈”及“分享到QQ空间”按钮的分享内容（1.4.0）
                    wx.updateTimelineShareData({
                        title: '我咋地咋地了', // 分享标题
                        link: baseUrl + 'viewer/view/share?ticket=' + that.ticket, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                        imgUrl: baseUrl + 'survey/img/avatar/29.png', // 分享图标
                        success: function () {
                        }
                    });
                });

                wx.error(function (res) {
                });
            },
            getSignature() {
                let that = this;
                $.ajax({
                    url: '/viewer/signature?currentUrl=' + encodeURIComponent(location.href.split('#')[0]),
                    type: 'GET',
                    async: false,
                    timeout:30000,
                    success: function (resp) {
                        if (resp.code == 200 && resp.data) {
                            that.signature = resp.data
                            that.initWxConfig(resp.data);
                        }
                    },
                    error: function (err) {
                        that.signature = null;
                    }
                });
            },
            initQRCode() {
                if (this.getQueryString("ticket")) {
                    this.ticket = this.getQueryString("ticket");
                    this.viewModel = true;
                }
                let that = this;
                if (this.getQueryString("code") || true) {
                    $.ajax({
                        url: '/viewer/share/getQRCode?code=' + this.getQueryString("code"),
                        type: 'GET',
                        async: false,
                        timeout:30000,
                        success: function (resp) {
                            if (resp.code == 200 && resp.data) {
                                that.ticket = resp.data.ticket;
                                that.getSignature();
                            } else {
                                that.userinfo = null;
                            }

                        },
                        error: function (err) {
                            that.userinfo = null;
                        }
                    });
                } else {
                    $.toast("未获取二维码信息", "cancel", function (toast) {
                    });
                }
            },
            getQueryString(name) {
                let reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
                let r = window.location.search.substr(1).match(reg);
                if (r != null) {
                    return unescape(r[2]);
                }
                return null;
            },
        }
    });
</script>

<script>

</script>
</html>