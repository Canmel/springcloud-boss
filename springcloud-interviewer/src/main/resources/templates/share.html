<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>我要推荐</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <link rel="stylesheet" href="/viewer/wx/css/weui.min.css">
    <link rel="stylesheet" href="/viewer/wx/css/weui.css">
    <link rel="stylesheet" href="/viewer/wx/css/jquery-weui.css">
    <link rel="stylesheet" href="/viewer/wx/css/demos.css">
    <script src="/viewer/wx/js/vue.js"></script>

    <script src="/viewer/wx/js/jquery-2.1.4.js"></script>
    <script src="/viewer/wx/js/jweixin-1.6.0.js"></script>

</head>
<body ontouchstart>
<div class="container" id="container">
    <div class="weui_msg" v-if="!ticket">
        <div class="weui_icon_area">
            <i class="weui_icon_cancel weui_icon_msg"></i></div>
        <div class="weui_text_area">
            <h2 class="weui_msg_title">无权限操作</h2>
            <p class="weui_msg_desc">请您完善个人信息后再次尝试</p>
        </div>
        <div class="weui_extra_area">
        </div>
    </div>
    <div class="weui-panel" style="padding-top: 10%;" v-if="ticket">
        <img v-bind:src="qrCodeSrc" v-if="ticket" style="width: 50%;">
        <p>我的推荐二维码，长按保存发给朋友，或者直接转发给朋友或朋友圈</p>
    </div>
</div>
<script src="/viewer/wx/js/fastclick.js"></script>
<script>
    $(function () {
        FastClick.attach(document.body);
    });
</script>
<script src="/viewer/wx/js/jquery-weui.js"></script>
<script src="/viewer/wx/js/ajax-util.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
</body>

<script type="application/javascript">
    new Vue({
        el: '#container',
        data: {
            ticket: null,
            qrCode: "https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=",
            signature: null
        },
        created: function () {
            this.initQRCode();
            this.getSignature();
        },
        methods: {
            qrCodeSrc() {
                return this.qrCode + this.ticket;
            },
            initWxConfig() {
                wx.config({
                    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId: this.signature.appId, // 必填，公众号的唯一标识
                    timestamp: this.signature.timestamp, // 必填，生成签名的时间戳
                    nonceStr: this.signature.nonceStr, // 必填，生成签名的随机串
                    signature: this.signature.signature,// 必填，签名
                    jsApiList: ["updateAppMessageShareData", "updateTimelineShareData"] // 必填，需要使用的JS接口列表
                });

                wx.ready(function(){
                    // 自定义“分享给朋友”及“分享到QQ”按钮的分享内容（1.4.0）
                    wx.updateAppMessageShareData({
                        title: '我咋地咋地了', // 分享标题
                        desc: '你也来咋地', // 分享描述
                        link: 'https://diaocha.svdata.cn/viewer/share?ticket=' + this.ticket, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                        imgUrl: 'https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1590344244053&di=7d13ff283b8eaa71b5a409fa10f231d2&imgtype=0&src=http%3A%2F%2F2.zol-img.com.cn%2Fzt%2Fmanual_4f4%2F0597408.jpg', // 分享图标
                        success: function () {
                            alert("分享成功");
                        }
                    });
                    // 自定义“分享到朋友圈”及“分享到QQ空间”按钮的分享内容（1.4.0）
                    wx.updateTimelineShareData({
                        title: '我咋地咋地了', // 分享标题
                        link: 'https://diaocha.svdata.cn/viewer/share?ticket=' + this.ticket, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                        imgUrl: 'https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1590344244053&di=7d13ff283b8eaa71b5a409fa10f231d2&imgtype=0&src=http%3A%2F%2F2.zol-img.com.cn%2Fzt%2Fmanual_4f4%2F0597408.jpg', // 分享图标
                        success: function () {
                            alert("分享成功");
                        }
                    });
                });

                wx.error(function(res){
                    alert("分享失败");
                });
            },
            getSignature() {
                let that = this;
                alert(location.href.split('#')[0]);
                $.ajax({
                    url: '/viewer/signature',
                    type: 'GET',
                    async: false,
                    success: function (resp) {
                        if (resp.code == 200 && resp.data) {
                            that.signature = resp.data
                        }
                        that.initWxConfig();
                    },
                    error: function (err) {
                        that.signature = null;
                    }
                });
            },
            initQRCode() {
                if(this.getQueryString("ticket")) {
                    this.ticket = this.getQueryString("ticket");
                }
                let that = this;
                if (this.getQueryString("code") || true) {
                    $.ajax({
                        url: '/viewer/share/getQRCode?code=' + this.getQueryString("code"),
                        type: 'GET',
                        async: false,
                        success: function (resp) {
                            if (resp.code == 200 && resp.data) {
                                that.ticket = resp.data.ticket;
                                that.qrCode += that.ticket;
                            } else {
                                that.userinfo = null;
                            }

                        },
                        error: function (err) {
                            that.userinfo = null;
                        }
                    });
                } else {
                    $.toast("未获取二维码信息", "cancel", function (toast) {
                    });
                }
            },
            getQueryString(name) {
                let reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
                let r = window.location.search.substr(1).match(reg);
                if (r != null) {
                    return unescape(r[2]);
                }
                return null;
            },
        }
    });
</script>

<script>

</script>
</html>